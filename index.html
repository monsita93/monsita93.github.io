<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodShare - Condividi cibo, riduci sprechi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .gradient-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #4f46e5 100%);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .hidden { display: none !important; }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg flex items-center gap-3">
            <div class="loading border-4 border-gray-200 border-t-green-500 rounded-full w-6 h-6"></div>
            <span>Caricamento...</span>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <div class="w-20 h-20 gradient-bg rounded-xl flex items-center justify-center mx-auto mb-4">
                    <span class="text-white font-bold text-2xl">F</span>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">FoodShare</h1>
                <p class="text-gray-600">Condividi cibo, riduci sprechi</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-6 text-center">Accedi per continuare</h2>
                
                <button
                    id="google-login-btn"
                    class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-300 rounded-lg px-6 py-3 text-gray-700 font-medium hover:bg-gray-50 hover:border-gray-400 transition-colors"
                >
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continua con Google
                </button>

                <div class="mt-4 text-center">
                    <button id="debug-btn" class="text-sm text-blue-600 hover:text-blue-800">
                        Debug Info (per sviluppatori)
                    </button>
                </div>

                <div id="debug-info" class="mt-4 p-3 bg-gray-100 rounded text-xs text-gray-600 hidden">
                    <div id="debug-content">Clicca "Debug Info" per vedere dettagli tecnici</div>
                </div>

                <div class="mt-6 text-center text-sm text-gray-500">
                    Accedendo accetti i nostri termini di servizio e la privacy policy
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-md mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 gradient-bg rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-sm">F</span>
                </div>
                <h1 class="text-xl font-bold text-gray-900">FoodShare</h1>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-1">
                    <svg class="h-4 w-4 text-yellow-500 fill-current" viewBox="0 0 24 24">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                    </svg>
                    <span class="text-sm text-gray-600">4.8</span>
                </div>
                
                <div class="flex items-center gap-2">
                    <img id="user-photo" src="" alt="User" class="w-8 h-8 rounded-full border-2 border-gray-200 hidden">
                    <div class="text-right">
                        <div id="user-name" class="text-sm font-medium text-gray-900 hidden"></div>
                    </div>
                    <button id="logout-btn" class="text-gray-500 hover:text-gray-700 hidden">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-md mx-auto p-4 pb-24">
        <!-- Browse View -->
        <div id="browse-view">
            <!-- Search Header -->
            <div class="gradient-bg text-white p-6 rounded-xl mb-6">
                <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                    <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    Trova cibo vicino a te
                </h2>
                
                <div class="space-y-4">
                    <div class="flex items-center gap-2 text-sm opacity-90">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        <span>Bari, Puglia</span>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <svg class="h-5 w-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                        <div class="flex-1">
                            <label class="block text-sm mb-2">Raggio di ricerca: <span id="radius-value">5</span> km</label>
                            <input
                                type="range"
                                id="search-radius"
                                min="1"
                                max="20"
                                value="5"
                                class="w-full h-2 bg-white bg-opacity-20 rounded-lg appearance-none cursor-pointer"
                            />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow-sm text-center border border-gray-100">
                    <div class="text-2xl font-bold text-green-600" id="nearby-count">0</div>
                    <div class="text-sm text-gray-600">Annunci vicini</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm text-center border border-gray-100">
                    <div class="text-2xl font-bold text-blue-600" id="total-listings">0</div>
                    <div class="text-sm text-gray-600">Totali</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm text-center border border-gray-100">
                    <div class="text-2xl font-bold text-orange-600" id="active-users">1</div>
                    <div class="text-sm text-gray-600">Online</div>
                </div>
            </div>

            <!-- Refresh Button -->
            <div class="mb-4 flex justify-center">
                <button id="refresh-btn" class="bg-white px-4 py-2 rounded-lg shadow-sm border border-gray-200 flex items-center gap-2 hover:bg-gray-50">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Aggiorna
                </button>
            </div>

            <!-- Listings Container -->
            <div id="listings-container" class="space-y-4"></div>

            <!-- No Results -->
            <div id="no-results" class="text-center py-12 hidden">
                <div class="text-6xl mb-4">🔍</div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Nessun annuncio nelle vicinanze</h3>
                <p class="text-gray-500">Prova ad aumentare il raggio di ricerca o aggiungi tu il primo annuncio!</p>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg hidden">
                <div class="flex items-center gap-2">
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM13 17h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                    <span>Errore nel caricamento degli annunci. <button class="underline" onclick="loadListings()">Riprova</button></span>
                </div>
            </div>
        </div>

        <!-- Add Listing View -->
        <div id="add-view" class="hidden">
            <div class="gradient-blue text-white p-6 rounded-xl mb-6">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Condividi cibo
                </h2>
                <p class="mt-2 opacity-90">Aiuta a ridurre lo spreco alimentare condividendo quello che non riesci a consumare</p>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Titolo dell'annuncio</label>
                    <input
                        type="text"
                        id="new-title"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="es. Verdure fresche dal giardino"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label>
                    <textarea
                        id="new-description"
                        rows="3"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Descrivi brevemente cosa condividi e in che condizioni si trova..."
                    ></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Emoji rappresentativa</label>
                    <div class="grid grid-cols-6 gap-2">
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="🥬">🥬</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="🍞">🍞</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="🍎">🍎</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="🍅">🍅</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="🥕">🥕</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="🧀">🧀</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="🍝">🍝</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="🥛">🥛</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="🍗">🍗</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="🐟">🐟</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="🥐">🥐</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="🍰">🍰</button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data di scadenza</label>
                    <input
                        type="date"
                        id="new-expiry"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Indirizzo di ritiro</label>
                    <input
                        type="text"
                        id="new-location"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="es. Via Roma 123, Bari"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contatto</label>
                    <input
                        type="text"
                        id="new-contact"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Il tuo telefono (es. 339 123 4567)"
                    />
                </div>

                <button
                    id="submit-listing"
                    class="w-full gradient-bg text-white py-3 px-6 rounded-lg font-medium hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
                >
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Pubblica annuncio
                </button>
            </div>
        </div>

        <!-- Detail View -->
        <div id="detail-view" class="hidden">
            <button id="back-btn" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 mb-6">
                ← Torna agli annunci
            </button>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div id="detail-image" class="h-64 bg-gray-100 flex items-center justify-center text-6xl border-b border-gray-200">
                    📷
                </div>

                <div class="p-6 space-y-6">
                    <div>
                        <h1 id="detail-title" class="text-2xl font-bold text-gray-900 mb-2"></h1>
                        <p id="detail-description" class="text-gray-600 leading-relaxed"></p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <div class="flex items-center gap-2 text-red-700 mb-1">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12,6 12,12 16,14"/>
                                </svg>
                                <span class="font-medium">Scadenza</span>
                            </div>
                            <p id="detail-expiry" class="text-red-800 font-semibold"></p>
                            <p id="detail-expiry-date" class="text-sm text-red-600 mt-1"></p>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <div class="flex items-center gap-2 text-blue-700 mb-1">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                    <circle cx="12" cy="10" r="3"/>
                                </svg>
                                <span class="font-medium">Distanza</span>
                            </div>
                            <p id="detail-distance" class="text-blue-800 font-semibold"></p>
                            <p id="detail-location" class="text-sm text-blue-600 mt-1"></p>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="flex items-center gap-2 text-gray-700 mb-2">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <span class="font-medium">Informazioni contatto</span>
                        </div>
                        <p id="detail-contact" class="text-gray-800"></p>
                    </div>

                    <div id="candidates-section" class="bg-orange-50 p-4 rounded-lg border border-orange-200 hidden">
                        <div class="flex items-center gap-2 text-orange-700 mb-2">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <span id="candidates-title" class="font-medium"></span>
                        </div>
                        <div id="candidates-list" class="space-y-2"></div>
                    </div>

                    <div class="flex gap-4">
                        <button
                            id="apply-btn"
                            class="flex-1 py-3 px-6 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors gradient-bg text-white hover:opacity-90"
                        >
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                            </svg>
                            Candidati per il ritiro
                        </button>

                        <button class="px-6 py-3 border border-blue-500 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-2">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            Contatta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40">
        <div class="max-w-md mx-auto flex">
            <button
                id="nav-browse"
                class="flex-1 py-4 flex flex-col items-center gap-1 transition-colors text-green-600 bg-green-50"
            >
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <span class="text-xs font-medium">Cerca</span>
            </button>

            <button
                id="nav-add"
                class="flex-1 py-4 flex flex-col items-center gap-1 transition-colors text-gray-600 hover:text-gray-800 hover:bg-gray-50"
            >
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                <span class="text-xs font-medium">Aggiungi</span>
            </button>
        </div>
    </nav>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCHN6FisiuH2JwboVcyrlg1UHnsLNAIWDE",
            authDomain: "foodshare-app-ff567.firebaseapp.com",
            databaseURL: "https://foodshare-app-ff567-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "foodshare-app-ff567",
            storageBucket: "foodshare-app-ff567.firebasestorage.app",
            messagingSenderId: "120193233604",
            appId: "1:120193233604:web:fa7afd4bde94b558378f91",
            measurementId: "G-2B7P1JMHES"
        };

        // Initialize Firebase
        let db, auth;
        let currentUser = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Error initializing Firebase:', error);
            showError('Errore di configurazione database');
        }

        // Google Auth Provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.addScope('profile');
        googleProvider.addScope('email');

        // Authentication State Observer
        auth.onAuthStateChanged(async (user) => {
            console.log('Auth state changed:', user ? user.displayName : 'No user');
            
            if (user) {
                // User is signed in
                currentUser = user;
                showMainApp();
                updateUserUI(user);
                loadListings();
            } else {
                // User is signed out
                currentUser = null;
                showLoginScreen();
            }
        });

        // Handle redirect result on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Page loaded, checking for redirect result...');
            await handleRedirectResult();
        });

        // Authentication Functions
        async function signInWithGoogle() {
            try {
                console.log('Attempting Google Sign In...');
                showLoading();
                
                // Try popup first, fallback to redirect if blocked
                try {
                    const result = await auth.signInWithPopup(googleProvider);
                    const user = result.user;
                    console.log('User signed in with popup:', user.displayName);
                    
                    // Save user data to Firestore
                    await saveUserData(user);
                    hideLoading();
                    
                } catch (popupError) {
                    console.error('Popup failed:', popupError);
                    
                    if (popupError.code === 'auth/popup-blocked' || popupError.code === 'auth/popup-closed-by-user') {
                        console.log('Falling back to redirect method...');
                        hideLoading();
                        
                        // Fallback to redirect
                        await auth.signInWithRedirect(googleProvider);
                        // Note: redirect will reload the page, so no code after this runs
                        
                    } else {
                        throw popupError; // Re-throw other errors
                    }
                }
                
            } catch (error) {
                console.error('Error signing in:', error);
                hideLoading();
                
                if (error.code === 'auth/popup-blocked') {
                    showError('Popup bloccato. Prova a disabilitare il blocco popup o ricarica la pagina.');
                } else if (error.code === 'auth/cancelled-popup-request') {
                    showError('Accesso annullato.');
                } else if (error.code === 'auth/unauthorized-domain') {
                    showError('Dominio non autorizzato. Controlla la configurazione Firebase.');
                } else {
                    showError(`Errore durante l'accesso: ${error.message}`);
                }
            }
        }
        
        // Handle redirect result when page loads
        async function handleRedirectResult() {
            try {
                const result = await auth.getRedirectResult();
                if (result.user) {
                    console.log('User signed in via redirect:', result.user.displayName);
                    await saveUserData(result.user);
                }
            } catch (error) {
                console.error('Redirect error:', error);
                showError('Errore durante il redirect di autenticazione');
            }
        }

        async function signOut() {
            try {
                await auth.signOut();
                console.log('User signed out');
            } catch (error) {
                console.error('Error signing out:', error);
                showError('Errore durante la disconnessione');
            }
        }

        async function saveUserData(user) {
            try {
                await db.collection('users').doc(user.uid).set({
                    name: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        // UI Functions
        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
        }

        function updateUserUI(user) {
            const userPhoto = document.getElementById('user-photo');
            const userName = document.getElementById('user-name');
            const logoutBtn = document.getElementById('logout-btn');

            if (user.photoURL) {
                userPhoto.src = user.photoURL;
                userPhoto.classList.remove('hidden');
            }

            if (user.displayName) {
                userName.textContent = user.displayName.split(' ')[0]; // Show only first name
                userName.classList.remove('hidden');
            }

            logoutBtn.classList.remove('hidden');
        }
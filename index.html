<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodShare - Condividi cibo, riduci sprechi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .gradient-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #4f46e5 100%);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .hidden { display: none !important; }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg flex items-center gap-3">
            <div class="loading border-4 border-gray-200 border-t-green-500 rounded-full w-6 h-6"></div>
            <span>Caricamento...</span>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-md mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 gradient-bg rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-sm">F</span>
                </div>
                <h1 class="text-xl font-bold text-gray-900">FoodShare</h1>
            </div>
            
            <div class="flex items-center gap-1">
                <svg class="h-4 w-4 text-yellow-500 fill-current" viewBox="0 0 24 24">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
                <span class="text-sm text-gray-600">4.8</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-md mx-auto p-4 pb-24">
        <!-- Browse View -->
        <div id="browse-view">
            <!-- Search Header -->
            <div class="gradient-bg text-white p-6 rounded-xl mb-6">
                <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                    <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    Trova cibo vicino a te
                </h2>
                
                <div class="space-y-4">
                    <div class="flex items-center gap-2 text-sm opacity-90">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        <span>Bari, Puglia</span>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <svg class="h-5 w-5 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                        <div class="flex-1">
                            <label class="block text-sm mb-2">Raggio di ricerca: <span id="radius-value">5</span> km</label>
                            <input
                                type="range"
                                id="search-radius"
                                min="1"
                                max="20"
                                value="5"
                                class="w-full h-2 bg-white bg-opacity-20 rounded-lg appearance-none cursor-pointer"
                            />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow-sm text-center border border-gray-100">
                    <div class="text-2xl font-bold text-green-600" id="nearby-count">0</div>
                    <div class="text-sm text-gray-600">Annunci vicini</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm text-center border border-gray-100">
                    <div class="text-2xl font-bold text-blue-600" id="total-listings">0</div>
                    <div class="text-sm text-gray-600">Totali</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm text-center border border-gray-100">
                    <div class="text-2xl font-bold text-orange-600" id="active-users">1</div>
                    <div class="text-sm text-gray-600">Online</div>
                </div>
            </div>

            <!-- Refresh Button -->
            <div class="mb-4 flex justify-center">
                <button id="refresh-btn" class="bg-white px-4 py-2 rounded-lg shadow-sm border border-gray-200 flex items-center gap-2 hover:bg-gray-50">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Aggiorna
                </button>
            </div>

            <!-- Listings Container -->
            <div id="listings-container" class="space-y-4"></div>

            <!-- No Results -->
            <div id="no-results" class="text-center py-12 hidden">
                <div class="text-6xl mb-4">üîç</div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Nessun annuncio nelle vicinanze</h3>
                <p class="text-gray-500">Prova ad aumentare il raggio di ricerca o aggiungi tu il primo annuncio!</p>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg hidden">
                <div class="flex items-center gap-2">
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM13 17h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                    <span>Errore nel caricamento degli annunci. <button class="underline" onclick="loadListings()">Riprova</button></span>
                </div>
            </div>
        </div>

        <!-- Add Listing View -->
        <div id="add-view" class="hidden">
            <div class="gradient-blue text-white p-6 rounded-xl mb-6">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Condividi cibo
                </h2>
                <p class="mt-2 opacity-90">Aiuta a ridurre lo spreco alimentare condividendo quello che non riesci a consumare</p>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Titolo dell'annuncio</label>
                    <input
                        type="text"
                        id="new-title"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="es. Verdure fresche dal giardino"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label>
                    <textarea
                        id="new-description"
                        rows="3"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Descrivi brevemente cosa condividi e in che condizioni si trova..."
                    ></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Emoji rappresentativa</label>
                    <div class="grid grid-cols-6 gap-2">
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="ü•¨">ü•¨</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="üçû">üçû</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="üçé">üçé</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="üçÖ">üçÖ</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="ü•ï">ü•ï</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="üßÄ">üßÄ</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="üçù">üçù</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="ü•õ">ü•õ</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="üçó">üçó</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="üêü">üêü</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="ü•ê">ü•ê</button>
                        <button type="button" class="emoji-btn text-3xl p-2 rounded hover:bg-gray-100" data-emoji="üç∞">üç∞</button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data di scadenza</label>
                    <input
                        type="date"
                        id="new-expiry"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Indirizzo di ritiro</label>
                    <input
                        type="text"
                        id="new-location"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="es. Via Roma 123, Bari"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contatto</label>
                    <input
                        type="text"
                        id="new-contact"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Il tuo nome e telefono (es. Mario - 339 123 4567)"
                    />
                </div>

                <button
                    id="submit-listing"
                    class="w-full gradient-bg text-white py-3 px-6 rounded-lg font-medium hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
                >
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Pubblica annuncio
                </button>
            </div>
        </div>

        <!-- Detail View -->
        <div id="detail-view" class="hidden">
            <button id="back-btn" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 mb-6">
                ‚Üê Torna agli annunci
            </button>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div id="detail-image" class="h-64 bg-gray-100 flex items-center justify-center text-6xl border-b border-gray-200">
                    üì∑
                </div>

                <div class="p-6 space-y-6">
                    <div>
                        <h1 id="detail-title" class="text-2xl font-bold text-gray-900 mb-2"></h1>
                        <p id="detail-description" class="text-gray-600 leading-relaxed"></p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <div class="flex items-center gap-2 text-red-700 mb-1">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12,6 12,12 16,14"/>
                                </svg>
                                <span class="font-medium">Scadenza</span>
                            </div>
                            <p id="detail-expiry" class="text-red-800 font-semibold"></p>
                            <p id="detail-expiry-date" class="text-sm text-red-600 mt-1"></p>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <div class="flex items-center gap-2 text-blue-700 mb-1">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                    <circle cx="12" cy="10" r="3"/>
                                </svg>
                                <span class="font-medium">Distanza</span>
                            </div>
                            <p id="detail-distance" class="text-blue-800 font-semibold"></p>
                            <p id="detail-location" class="text-sm text-blue-600 mt-1"></p>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="flex items-center gap-2 text-gray-700 mb-2">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <span class="font-medium">Informazioni contatto</span>
                        </div>
                        <p id="detail-contact" class="text-gray-800"></p>
                    </div>

                    <div id="candidates-section" class="bg-orange-50 p-4 rounded-lg border border-orange-200 hidden">
                        <div class="flex items-center gap-2 text-orange-700 mb-2">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <span id="candidates-title" class="font-medium"></span>
                        </div>
                        <div id="candidates-list" class="space-y-2"></div>
                    </div>

                    <div class="flex gap-4">
                        <button
                            id="apply-btn"
                            class="flex-1 py-3 px-6 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors gradient-bg text-white hover:opacity-90"
                        >
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                            </svg>
                            Candidati per il ritiro
                        </button>

                        <button class="px-6 py-3 border border-blue-500 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-2">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            Contatta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40">
        <div class="max-w-md mx-auto flex">
            <button
                id="nav-browse"
                class="flex-1 py-4 flex flex-col items-center gap-1 transition-colors text-green-600 bg-green-50"
            >
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <span class="text-xs font-medium">Cerca</span>
            </button>

            <button
                id="nav-add"
                class="flex-1 py-4 flex flex-col items-center gap-1 transition-colors text-gray-600 hover:text-gray-800 hover:bg-gray-50"
            >
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                <span class="text-xs font-medium">Aggiungi</span>
            </button>
        </div>
    </nav>

    <script>
        // Firebase Configuration - SOSTITUISCI CON I TUOI DATI
        const firebaseConfig = {
            apiKey: "your-api-key-here",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };
		


        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Error initializing Firebase:', error);
            showError('Errore di configurazione database');
        }

        // App State
        let currentView = 'browse';
        let selectedListing = null;
        let searchRadius = 5;
        let selectedEmoji = 'ü•¨';
        let listings = [];

        // Utility functions
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.querySelector('span').textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function formatTimeLeft(expiryDate) {
            const now = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return "Scade oggi";
            if (diffDays === 1) return "Scade domani";
            if (diffDays > 1) return `Scade tra ${diffDays} giorni`;
            return "Scaduto";
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(1); // Distance in km
        }

        function getFilteredListings() {
            return listings.filter(listing => listing.distance <= searchRadius);
        }

        // Firebase Database Functions
        async function loadListings() {
            try {
                showLoading();
                const snapshot = await db.collection('listings')
                    .where('expiryDate', '>=', new Date().toISOString().split('T')[0])
                    .orderBy('expiryDate')
                    .orderBy('createdAt', 'desc')
                    .get();

                listings = [];
                const userLat = 41.1171; // Default to Bari coordinates
                const userLng = 16.8719;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const listing = {
                        id: doc.id,
                        ...data,
                        distance: calculateDistance(
                            userLat, userLng,
                            data.coords?.lat || userLat,
                            data.coords?.lng || userLng
                        )
                    };
                    listings.push(listing);
                });

                renderListings();
                hideLoading();
                
            } catch (error) {
                console.error('Error loading listings:', error);
                showError('Errore nel caricamento degli annunci');
                hideLoading();
            }
        }

        async function saveListing(listingData) {
            try {
                showLoading();
                
                const docData = {
                    ...listingData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    coords: { lat: 41.1171, lng: 16.8719 }, // Default coordinates
                    candidates: [],
                    status: 'active'
                };

                const docRef = await db.collection('listings').add(docData);
                console.log('Listing saved with ID:', docRef.id);
                
                hideLoading();
                return docRef.id;
                
            } catch (error) {
                console.error('Error saving listing:', error);
                showError('Errore nel salvataggio dell\'annuncio');
                hideLoading();
                throw error;
            }
        }

        async function addCandidate(listingId, candidateData) {
            try {
                showLoading();
                
                await db.collection('listings').doc(listingId).update({
                    candidates: firebase.firestore.FieldValue.arrayUnion(candidateData),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                hideLoading();
                
            } catch (error) {
                console.error('Error adding candidate:', error);
                showError('Errore nell\'invio della candidatura');
                hideLoading();
                throw error;
            }
        }

        // UI Functions
        function showView(viewName) {
            document.getElementById('browse-view').classList.add('hidden');
            document.getElementById('add-view').classList.add('hidden');
            document.getElementById('detail-view').classList.add('hidden');
            
            document.getElementById(viewName + '-view').classList.remove('hidden');
            
            // Update navigation
            document.getElementById('nav-browse').className = 'flex-1 py-4 flex flex-col items-center gap-1 transition-colors text-gray-600 hover:text-gray-800 hover:bg-gray-50';
            document.getElementById('nav-add').className = 'flex-1 py-4 flex flex-col items-center gap-1 transition-colors text-gray-600 hover:text-gray-800 hover:bg-gray-50';
            
            if (viewName === 'browse') {
                document.getElementById('nav-browse').className = 'flex-1 py-4 flex flex-col items-center gap-1 transition-colors text-green-600 bg-green-50';
            } else if (viewName === 'add') {
                document.getElementById('nav-add').className = 'flex-1 py-4 flex flex-col items-center gap-1 transition-colors text-green-600 bg-green-50';
            }
            
            currentView = viewName;
        }

        function renderListings() {
            const container = document.getElementById('listings-container');
            const filteredListings = getFilteredListings();
            
            // Update statistics
            document.getElementById('nearby-count').textContent = filteredListings.length;
            document.getElementById('total-listings').textContent = listings.length;
            
            if (filteredListings.length === 0) {
                container.innerHTML = '';
                document.getElementById('no-results').classList.remove('hidden');
                return;
            }
            
            document.getElementById('no-results').classList.add('hidden');
            
            container.innerHTML = filteredListings.map(listing => `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md transition-shadow cursor-pointer card-hover" data-listing-id="${listing.id}">
                    <div class="flex gap-4">
                        <div class="w-20 h-20 bg-gray-100 rounded-lg flex items-center justify-center text-3xl border-2 border-gray-200">
                            ${listing.image}
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between mb-2">
                                <h3 class="font-semibold text-gray-900 text-lg">${listing.title}</h3>
                                <div class="flex items-center gap-2 text-sm text-gray-500">
                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                        <circle cx="12" cy="10" r="3"/>
                                    </svg>
                                    <span>${listing.distance} km</span>
                                </div>
                            </div>
                            
                            <p class="text-gray-600 text-sm mb-3 line-clamp-2">${listing.description}</p>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="flex items-center gap-1 text-sm text-red-600">
                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <circle cx="12" cy="12" r="10"/>
                                            <polyline points="12,6 12,12 16,14"/>
                                        </svg>
                                        <span class="font-medium">${formatTimeLeft(listing.expiryDate)}</span>
                                    </div>
                                    
                                    ${listing.candidates && listing.candidates.length > 0 ? `
                                    <div class="flex items-center gap-1 text-sm text-blue-600">
                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                            <circle cx="12" cy="7" r="4"/>
                                        </svg>
                                        <span>${listing.candidates.length} interessat${listing.candidates.length === 1 ? 'o' : 'i'}</span>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <div class="text-sm text-gray-500">
                                    da ${listing.postedBy}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Add click listeners to listings
            container.querySelectorAll('[data-listing-id]').forEach(el => {
                el.addEventListener('click', () => {
                    const id = el.dataset.listingId;
                    selectedListing = listings.find(l => l.id === id);
                    showDetailView();
                });
            });
        }

        function showDetailView() {
            if (!selectedListing) return;
            
            document.getElementById('detail-image').textContent = selectedListing.image;
            document.getElementById('detail-title').textContent = selectedListing.title;
            document.getElementById('detail-description').textContent = selectedListing.description;
            document.getElementById('detail-expiry').textContent = formatTimeLeft(selectedListing.expiryDate);
            document.getElementById('detail-expiry-date').textContent = selectedListing.expiryDate;
            document.getElementById('detail-distance').textContent = selectedListing.distance + ' km da te';
            document.getElementById('detail-location').textContent = selectedListing.location;
            document.getElementById('detail-contact').textContent = selectedListing.contactInfo;
            
            // Handle candidates
            if (selectedListing.candidates && selectedListing.candidates.length > 0) {
                const candidatesSection = document.getElementById('candidates-section');
                const candidatesTitle = document.getElementById('candidates-title');
                const candidatesList = document.getElementById('candidates-list');
                
                candidatesSection.classList.remove('hidden');
                candidatesTitle.textContent = `${selectedListing.candidates.length} utent${selectedListing.candidates.length === 1 ? 'e' : 'i'} interessat${selectedListing.candidates.length === 1 ? 'o' : 'i'}`;
                
                candidatesList.innerHTML = selectedListing.candidates.map(candidate => `
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-orange-800 font-medium">${candidate.name}</span>
                        <span class="text-orange-600">${candidate.time}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('candidates-section').classList.add('hidden');
            }
            
            // Handle apply button
            const applyBtn = document.getElementById('apply-btn');
            const hasApplied = selectedListing.candidates && selectedListing.candidates.some(c => c.name === "Tu");
            
            if (hasApplied) {
                applyBtn.className = 'flex-1 py-3 px-6 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors bg-gray-200 text-gray-500 cursor-not-allowed';
                applyBtn.innerHTML = `
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    Gi√† candidato
                `;
                applyBtn.disabled = true;
            } else {
                applyBtn.className = 'flex-1 py-3 px-6 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors gradient-bg text-white hover:opacity-90';
                applyBtn.innerHTML = `
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    Candidati per il ritiro
                `;
                applyBtn.disabled = false;
            }
            
            showView('detail');
        }

        async function handleApplication() {
            if (!selectedListing || !selectedListing.id) return;
            
            try {
                const candidateData = {
                    name: "Tu",
                    time: new Date().toLocaleTimeString('it-IT', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }) + ' di oggi',
                    timestamp: new Date()
                };
                
                await addCandidate(selectedListing.id, candidateData);
                
                // Update local data
                if (!selectedListing.candidates) {
                    selectedListing.candidates = [];
                }
                selectedListing.candidates.push(candidateData);
                
                // Update the listing in the listings array
                const listingIndex = listings.findIndex(l => l.id === selectedListing.id);
                if (listingIndex !== -1) {
                    listings[listingIndex] = selectedListing;
                }
                
                showDetailView(); // Refresh the detail view
                alert('Ti sei candidato con successo! Il proprietario ti contatter√† presto.');
                
            } catch (error) {
                console.error('Error applying for listing:', error);
            }
        }

        async function submitListing() {
            const title = document.getElementById('new-title').value.trim();
            const description = document.getElementById('new-description').value.trim();
            const expiry = document.getElementById('new-expiry').value;
            const location = document.getElementById('new-location').value.trim();
            const contact = document.getElementById('new-contact').value.trim();
            
            if (!title || !description || !expiry || !location || !contact) {
                alert('Per favore compila tutti i campi obbligatori');
                return;
            }
            
            const expiryDate = new Date(expiry);
            const today = new Date();
            if (expiryDate < today) {
                alert('La data di scadenza deve essere futura');
                return;
            }
            
            try {
                const listingData = {
                    title,
                    description,
                    image: selectedEmoji,
                    expiryDate: expiry,
                    location,
                    contactInfo: contact,
                    postedBy: "Tu"
                };
                
                const newId = await saveListing(listingData);
                
                // Clear form
                document.getElementById('new-title').value = '';
                document.getElementById('new-description').value = '';
                document.getElementById('new-expiry').value = '';
                document.getElementById('new-location').value = '';
                document.getElementById('new-contact').value = '';
                selectedEmoji = 'ü•¨';
                updateEmojiSelection();
                
                showView('browse');
                loadListings(); // Reload listings to show the new one
                alert('Annuncio pubblicato con successo!');
                
            } catch (error) {
                console.error('Error submitting listing:', error);
            }
        }

        function updateEmojiSelection() {
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'border-2', 'border-blue-500');
                if (btn.dataset.emoji === selectedEmoji) {
                    btn.classList.add('bg-blue-100', 'border-2', 'border-blue-500');
                }
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('new-expiry').min = today;
            
            // Navigation
            document.getElementById('nav-browse').addEventListener('click', () => showView('browse'));
            document.getElementById('nav-add').addEventListener('click', () => showView('add'));
            document.getElementById('back-btn').addEventListener('click', () => showView('browse'));
            
            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', loadListings);
            
            // Search radius
            const radiusSlider = document.getElementById('search-radius');
            const radiusValue = document.getElementById('radius-value');
            
            radiusSlider.addEventListener('input', (e) => {
                searchRadius = parseInt(e.target.value);
                radiusValue.textContent = searchRadius;
                renderListings();
            });
            
            // Emoji selection
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedEmoji = btn.dataset.emoji;
                    updateEmojiSelection();
                });
            });
            
            // Submit listing
            document.getElementById('submit-listing').addEventListener('click', submitListing);
            
            // Apply for listing
            document.getElementById('apply-btn').addEventListener('click', handleApplication);
            
            // Initialize
            updateEmojiSelection();
            loadListings();
        });

        // Auto-refresh every 30 seconds
        setInterval(loadListings, 30000);
    </script>
</body>
</html>